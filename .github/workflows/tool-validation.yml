name: Tool Validation

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-all-tools:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio

    - name: Validate Tool Registration
      run: |
        python -c "
        import asyncio
        from kotlin_mcp_server import KotlinMCPServer
        
        async def validate_tools():
            server = KotlinMCPServer('tool-validator')
            tools_result = await server.handle_list_tools()
            tools = tools_result.get('tools', [])
            
            print(f'ðŸ“‹ Found {len(tools)} registered tools')
            
            expected_tools = [
                'analyze_and_refactor_project', 'analyze_code_with_ai', 'analyze_project',
                'call_external_api', 'create_compose_component', 'create_custom_view',
                'create_kotlin_file', 'create_layout_file', 'encrypt_sensitive_data',
                'enhance_existing_code', 'format_code', 'generate_code_with_ai',
                'generate_docs', 'generate_unit_tests', 'gradle_build',
                'implement_gdpr_compliance', 'implement_hipaa_compliance', 'manage_dependencies',
                'manage_project_files', 'optimize_build_performance', 'query_llm',
                'run_lint', 'run_tests', 'setup_cloud_sync', 'setup_dependency_injection',
                'setup_external_api', 'setup_mvvm_architecture', 'setup_retrofit_api',
                'setup_room_database', 'setup_secure_storage', 'setup_ui_testing'
            ]
            
            tool_names = [tool['name'] for tool in tools]
            missing_tools = [tool for tool in expected_tools if tool not in tool_names]
            extra_tools = [tool for tool in tool_names if tool not in expected_tools]
            
            if missing_tools:
                print(f'âŒ Missing tools: {missing_tools}')
                exit(1)
            
            if extra_tools:
                print(f'â„¹ï¸  Extra tools found: {extra_tools}')
            
            print(f'âœ… All {len(expected_tools)} expected tools are registered')
            
            # Validate tool schemas
            for tool in tools:
                assert 'name' in tool, f'Tool missing name: {tool}'
                assert 'description' in tool, f'Tool {tool[\"name\"]} missing description'
                assert 'inputSchema' in tool, f'Tool {tool[\"name\"]} missing inputSchema'
                
            print('âœ… All tool schemas are valid')
        
        asyncio.run(validate_tools())
        "

    - name: Test Tool Categories
      run: |
        python -c "
        import asyncio
        import tempfile
        from kotlin_mcp_server import KotlinMCPServer
        
        async def test_tool_categories():
            server = KotlinMCPServer('category-test')
            server.set_project_path(tempfile.mkdtemp())
            
            # Test Kotlin creation tools
            kotlin_tools = [
                ('create_kotlin_file', {'file_name': 'TestClass.kt', 'package_name': 'com.test', 'file_type': 'class'}),
                ('generate_code_with_ai', {'prompt': 'Create a simple Kotlin data class', 'code_type': 'data_class'}),
                ('format_code', {'file_path': 'TestClass.kt', 'format_type': 'kotlin'})
            ]
            
            print('ðŸ”§ Testing Kotlin creation tools...')
            for tool_name, args in kotlin_tools:
                result = await server.handle_call_tool(tool_name, args)
                assert 'content' in result, f'{tool_name} should return content'
            print('âœ… Kotlin creation tools working')
            
            # Test Android component tools
            android_tools = [
                ('create_compose_component', {'component_name': 'TestComponent', 'component_type': 'basic'}),
                ('create_custom_view', {'view_name': 'TestView', 'view_type': 'custom'}),
                ('create_layout_file', {'layout_name': 'test_layout', 'layout_type': 'linear'})
            ]
            
            print('ðŸ“± Testing Android component tools...')
            for tool_name, args in android_tools:
                result = await server.handle_call_tool(tool_name, args)
                assert 'content' in result, f'{tool_name} should return content'
            print('âœ… Android component tools working')
            
            # Test Gradle tools
            gradle_tools = [
                ('gradle_build', {'task': 'build', 'module': 'app'}),
                ('manage_dependencies', {'dependency_action': 'add', 'dependency': 'androidx.core:core-ktx:1.8.0'}),
                ('optimize_build_performance', {'optimization_type': 'gradle_cache'})
            ]
            
            print('ðŸ”¨ Testing Gradle tools...')
            for tool_name, args in gradle_tools:
                result = await server.handle_call_tool(tool_name, args)
                assert 'content' in result, f'{tool_name} should return content'
            print('âœ… Gradle tools working')
            
            # Test AI tools
            ai_tools = [
                ('generate_code_with_ai', {'prompt': 'Create a simple function', 'code_type': 'function'}),
                ('analyze_code_with_ai', {'file_path': 'Test.kt', 'analysis_type': 'basic'}),
                ('generate_unit_tests', {'class_path': 'com.example.TestClass', 'test_type': 'basic'})
            ]
            
            print('ðŸ¤– Testing AI tools...')
            for tool_name, args in ai_tools:
                result = await server.handle_call_tool(tool_name, args)
                assert 'content' in result, f'{tool_name} should return content'
            print('âœ… AI tools working')
            
            print('ðŸŽ¯ All tool categories validated successfully!')
        
        asyncio.run(test_tool_categories())
        "

    - name: Test Error Handling
      run: |
        python -c "
        import asyncio
        import tempfile
        from kotlin_mcp_server import KotlinMCPServer
        
        async def test_error_handling():
            server = KotlinMCPServer('error-test')
            server.set_project_path(tempfile.mkdtemp())
            
            print('ðŸ” Testing error handling...')
            
            # Test invalid tool name
            result = await server.handle_call_tool('invalid_tool_name', {})
            assert 'content' in result
            # Should handle gracefully with an error message
            print('âœ… Invalid tool handling works')
            
            # Test tools with empty arguments
            result = await server.handle_call_tool('create_kotlin_file', {})
            assert 'content' in result  # Should handle gracefully
            print('âœ… Empty arguments handling works')
            
            # Test tools with minimal arguments
            result = await server.handle_call_tool('analyze_project', {})
            assert 'content' in result
            print('âœ… Minimal arguments handling works')
            
            print('ðŸ›¡ï¸  Error handling validation complete!')
        
        asyncio.run(test_error_handling())
        "

    - name: Generate Tool Report
      run: |
        python -c "
        import asyncio
        import json
        from kotlin_mcp_server import KotlinMCPServer
        
        async def generate_report():
            server = KotlinMCPServer('report-generator')
            tools_result = await server.handle_list_tools()
            tools = tools_result.get('tools', [])
            
            # Generate tool report
            report = {
                'total_tools': len(tools),
                'tools_by_category': {},
                'tool_details': []
            }
            
            categories = {
                'kotlin': ['create_kotlin_file', 'generate_code_with_ai', 'format_code'],
                'android': ['create_compose_component', 'create_custom_view', 'create_layout_file'],
                'ui': ['create_compose_component', 'create_custom_view', 'create_layout_file'],
                'architecture': ['setup_mvvm_architecture', 'setup_dependency_injection'],
                'gradle': ['gradle_build', 'manage_dependencies', 'optimize_build_performance'],
                'quality': ['format_code', 'run_lint', 'generate_docs', 'analyze_project', 'run_tests'],
                'database': ['setup_room_database', 'setup_retrofit_api'],
                'security': ['encrypt_sensitive_data', 'setup_secure_storage', 'setup_cloud_sync', 'implement_gdpr_compliance', 'implement_hipaa_compliance'],
                'ai': ['generate_code_with_ai', 'analyze_code_with_ai', 'enhance_existing_code', 'query_llm', 'analyze_and_refactor_project'],
                'testing': ['generate_unit_tests', 'setup_ui_testing'],
                'api': ['call_external_api', 'setup_external_api'],
                'project': ['manage_project_files', 'analyze_and_refactor_project']
            }
            
            for category, tool_names in categories.items():
                count = sum(1 for tool in tools if tool['name'] in tool_names)
                report['tools_by_category'][category] = count
            
            for tool in tools:
                report['tool_details'].append({
                    'name': tool['name'],
                    'description': tool.get('description', 'No description'),
                    'has_schema': 'inputSchema' in tool
                })
            
            with open('tool_report.json', 'w') as f:
                json.dump(report, f, indent=2)
            
            print(f'ðŸ“Š Generated tool report: {report[\"total_tools\"]} tools')
            for category, count in report['tools_by_category'].items():
                print(f'  {category}: {count} tools')
        
        asyncio.run(generate_report())
        "

    - name: Upload Tool Report
      uses: actions/upload-artifact@v4
      with:
        name: tool-validation-report
        path: tool_report.json
        retention-days: 30

    - name: Summary
      run: |
        echo "## Tool Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f tool_report.json ]; then
          echo "### Tool Categories" >> $GITHUB_STEP_SUMMARY
          python -c "
          import json
          with open('tool_report.json', 'r') as f:
              report = json.load(f)
          print(f'- **Total Tools**: {report[\"total_tools\"]}')
          for category, count in report['tools_by_category'].items():
              print(f'- **{category.title()}**: {count} tools')
          " >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All tools validated successfully!" >> $GITHUB_STEP_SUMMARY
